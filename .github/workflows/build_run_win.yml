name: Power Balance Models Windows
on: [push]
jobs:
  test_modelica_build:
    name: Test Modelica ${{ matrix.om }} Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    env:
      OPENMODELICAHOME: "C:\\Program Files\\OpenModelica${{ matrix.om }}-64bit"
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest]
        om: ['1.18.1']
    steps:
      - uses: actions/checkout@v2
      - name: Install OpenModelica
        run: choco install openmodelica --version ${{ matrix.om }}
      - name: Compile models
        run: |
          mkdir build
          cd build
          for i in $(ls ${GITHUB_WORKSPACE}/power_balance/models/*.mo); do omc -s $i; done
          for i in $(ls *.makefile); do make -f $i; done
        shell: bash
      - name: Archive Modelica Binaries
        uses: actions/upload-artifact@v2
        with:
          name: om-binaries
          path: build/
          retention-days: 1
  test_module_build:
    name: Test Module Build (Python${{ matrix.python-version }} ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest]
        python-version: [ '3.8', '3.9', '3.10' ]
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
          architecture: x64
      - uses: Gr1N/setup-poetry@v7
      - name: Build Module
        run: |
          poetry install
          poetry build
          poetry run powerbalance generate-profiles
        shell: bash
      - name: Archive Plasma Profiles
        uses: actions/upload-artifact@v2
        with:
          name: om-plasma-profiles
          path: power_balance/profiles/mat_profile_files/*.mat
          retention-days: 1
  model_run_om:
    name: Model Run Open Modelica ${{ matrix.om }} (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    env:
      OPENMODELICAHOME: "C:\\Program Files\\OpenModelica${{ matrix.om }}-64bit"
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest]
        om: ['1.18.1']
    needs: [test_modelica_build]
    steps:
      - name: Retrieve Open Modelica model binaries
        uses: actions/download-artifact@v2
        with:
          name: om-binaries
          path: build
      - name: Retrieve Plasma profiles
        uses: actions/download-artifact@v2
        with:
          name: om-plasma-profiles
          path: power_balance/profiles/mat_profile_files
      - name: Install OpenModelica
        run: choco install openmodelica --version ${{ matrix.om }}
      - name: Run Models
        run: |
          cd build
          for i in $(ls -I "*.h" -I "*.c" -I "*.o" -I "*.json" -I "*.xml" -I "*.makefile" -I "*.mat"); do echo "Running model $i"; chmod +x ./$i; ./$i; done
        shell: bash
  model_run_api:
    name: Model Run API (${{ matrix.os }} Python${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    env:
      OPENMODELICAHOME: "C:\\Program Files\\OpenModelica${{ matrix.om }}-64bit"
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest]
        om: ['1.18.1']
        python-version: [ '3.8', '3.9', '3.10' ]
    needs: [test_module_build]
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
          architecture: x64
      - uses: Gr1N/setup-poetry@v7
      - name: Install OpenModelica
        run: choco install openmodelica --version ${{ matrix.om }}
      - name: Run Models
        run: |
          poetry install
          poetry run coverage run --source=power_balance --data-file=coverage_default -m pytest tests/scenarios -k test_run_vanilla
      - name: Archive Run Coverage
        uses: actions/upload-artifact@v2
        if: ${{ github.ref_name == 'main' }}
        with:
          name: coverage-run
          path: coverage_default
          retention-days: 1
  regression_tests:
    name: Regression Tests (${{ matrix.os }} Python${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    env:
      OPENMODELICAHOME: "C:\\Program Files\\OpenModelica${{ matrix.om }}-64bit"
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest]
        om: ['1.18.1']
        python-version: [ '3.8', '3.9', '3.10' ]
    needs: [test_module_build]
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
          architecture: x64
      - uses: Gr1N/setup-poetry@v7
      - name: Install OpenModelica
        run: choco install openmodelica --version ${{ matrix.om }}
      - name: Run Regression Tests
        run: |
          poetry install
          poetry run pytest tests/regression_tests
        shell: bash
  unit_tests:
    name: Unit Tests (${{ matrix.os }} Python${{ matrix.python-version }})
    env:
      OPENMODELICAHOME: "C:\\Program Files\\OpenModelica${{ matrix.om }}-64bit"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest]
        om: ['1.18.1']
        python-version: [ '3.8', '3.9', '3.10' ]
    needs: [test_module_build]
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
          architecture: x64
      - uses: Gr1N/setup-poetry@v7
      - name: Install OpenModelica
        run: choco install openmodelica --version ${{ matrix.om }}
      - name: Run Unit Tests
        run: |
          poetry install
          poetry run pytest tests/unit_tests
        shell: bash
